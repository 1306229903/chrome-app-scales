<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <title>应用外网页</title>
  </head>
  <body>
    <p>
      我使用这个网页测试外部网页能否通过<a target="_blank" href="https://crxdoc-zh.appspot.com/apps/manifest/externally_connectable">外部消息传递</a>连接到应用程序。
    </p>

    <p>
      <button id="test">打印串行端口数据</button>
    </p>
    <p>
      电子秤的实时读数：<input type="text" id="input">
    </p>
    <script>
      var eid = 'bpdfliajheklejkpfpdfncekafemlbpo'; // 应用 ID，在 chrome://extensions/ 查看

      var port = chrome.runtime.connect( eid , { name : 'x' } );

      port.onMessage.addListener(
              /**
               * 这个回调函数处理应用回应客户端传递的消息
               * @param {Message} msg
               */
              function ( msg ) {
                switch ( msg.response ) {
                  case 'get snapshot':
                    var data = msg.data;
                    alert( JSON.stringify( data ) );
                    break;
                }
              } );

      port.onMessage.addListener(
              /**
               * 这个回调函数处理由应用主动推送过来的消息
               * @param {Message} msg
               */
              function ( msg ) {
                switch ( msg.type ) {
                  case 'data change':
                    var data = msg.data;
                    document.getElementById( 'input' ).value = data.newData;
                    break;
                }
              } );

      document.getElementById( 'test' ).addEventListener( 'click' , function () {
        port.postMessage( { action : 'get snapshot' } );
      } );

      /**
       * 消息类型分为两种，一种是应用主动推送过来的消息，另一种是对客户端消息的回应。
       * @typedef {Object} Message
       * @property {String} [type] - 如果是应用主动推送过来的消息，则这个值为应用的消息类型，否则为空
       * @property {String} [response] - 如果是对客户端消息的回应，则这个值为客户端发送给应用的 action，否则为空
       * @property {*} data - 应用传递给客户端的任意数据
       */
    </script>
  </body>
</html>
