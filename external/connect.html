<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <title>应用外网页</title>
    <style>
      #input {
        font-size: 40px;
        color: red;
      }
    </style>
  </head>
  <body>
    <p>
      这个网页展示了如何在外部网页里读取设备的值。打开 Console 可以查看运行日志。
    </p>

    <p>
      <button id="test">打印所有设备的数据</button>
      ，在 Console 中查看数据
    </p>
    <p>
      电子秤的实时读数：<span id="input"></span>
    </p>
    <p>
      Chrome 能检测到设备断开了，但是不能检测到新设备接入，所以如果是在浏览器启动后再接入了设备，需要通知应用连接一下：<br>
      <button id="connect">通知应用连接到设备</button>
    </p>
    <script>
      var eid = 'bpdfliajheklejkpfpdfncekafemlbpo'; // 应用 ID，在 chrome://extensions/ 查看

      var port = chrome.runtime.connect( eid , { name : 'x' } );

      port.onMessage.addListener(
              /**
               * 这个回调函数处理应用回应客户端传递的消息
               * @param {Message} msg
               */
              function ( msg ) {
                var data = msg.data;
                switch ( msg.response ) {
                  case 'get snapshot':
                    console.log( '目前所有设备的数据为：' , data );
                    break;
                }
              } );

      port.onMessage.addListener(
              /**
               * 这个回调函数处理由应用主动推送过来的消息
               * @param {Message} msg
               */
              function ( msg ) {
                var data = msg.data;
                switch ( msg.type ) {
                  case 'data change':
                    document.getElementById( 'input' ).textContent = data.newData;
                    break;

                  case 'connection error':
                    console.log( '连接' + data.connectionId + '断开了，原因：' + data.error );
                    break;
                }
              } );

      document.getElementById( 'test' ).addEventListener( 'click' , function () {
        port.postMessage( { action : 'get snapshot' } );
      } );

      document.getElementById( 'connect' ).addEventListener( 'click' , function () {
        port.postMessage( { action : 'connect all devices' } );
      } );

      /**
       * 消息类型分为两种，一种是应用主动推送过来的消息，另一种是对客户端消息的回应。
       * @typedef {Object} Message
       * @property {String} [type] - 如果是应用主动推送过来的消息，则这个值为应用的消息类型，否则为空
       * @property {String} [response] - 如果是对客户端消息的回应，则这个值为客户端发送给应用的 action，否则为空
       * @property {*} data - 应用传递给客户端的任意数据
       */
    </script>
  </body>
</html>
